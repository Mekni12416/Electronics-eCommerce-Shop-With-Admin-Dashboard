pipeline {
    agent any

    // =====================================================
    // üåç VARIABLES D‚ÄôENVIRONNEMENT GLOBALES
    // =====================================================
    environment {

        // -------- Docker --------
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_USERNAME = 'jihedmekni'

        // -------- SonarQube --------
        SONAR_HOST_URL   = 'http://51.68.70.207:30090'
        SONAR_PROJECT_KEY = 'devops-fullstack'

        // -------- Frontend --------
        API_URL = 'http://51.68.70.207:30081'

        // -------- Kubernetes (k3s) --------
        KUBECONFIG     = '/var/lib/jenkins/.kube/config'
        KUBE_NAMESPACE = 'default'
    }

    // =====================================================
    // ‚è±Ô∏è TRIGGERS
    // =====================================================
    triggers {
        pollSCM('H/5 * * * *')
    }

    stages {

        // =====================================================
        // 1Ô∏è‚É£ CHECKOUT
        // =====================================================
        stage('Checkout') {
            steps {
                echo "üì• Cloning repository..."
                checkout scm
                sh 'git branch --show-current'
            }
        }

        // =====================================================
        // 2Ô∏è‚É£ INSTALL DEPENDENCIES
        // =====================================================
        stage('Install Dependencies') {
            parallel {

                stage('Backend') {
                    steps {
                        dir('server') {
                            sh 'npm ci'
                        }
                    }
                }

                stage('Frontend') {
                    steps {
                        sh 'npm ci'
                    }
                }
            }
        }

        // =====================================================
        // 3Ô∏è‚É£ SAST - SONARQUBE
        // =====================================================
        stage('SAST - SonarQube Analysis') {
            steps {
                echo "üîç Running SonarQube analysis..."

                withCredentials([string(
                    credentialsId: 'sonar-token',
                    variable: 'SONAR_TOKEN'
                )]) {
                    sh '''
                        docker run --rm \
                          -v "$(pwd):/usr/src" \
                          sonarsource/sonar-scanner-cli \
                          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                          -Dsonar.sources=. \
                          -Dsonar.host.url=${SONAR_HOST_URL} \
                          -Dsonar.login=${SONAR_TOKEN} \
                          -Dsonar.exclusions=**/node_modules/**,**/coverage/**,**/dist/**,**/build/**,**/Jenkinsfile,**/*.md
                    '''
                }
            }
        }

        // =====================================================
        // 4Ô∏è‚É£ BUILD DOCKER IMAGES
        // =====================================================
        stage('Build Docker Images') {
            parallel {

                stage('Backend Image') {
                    steps {
                        dir('server') {
                            sh '''
                                docker build -t ${DOCKER_USERNAME}/devops-backend:${BUILD_NUMBER} .
                                docker tag  ${DOCKER_USERNAME}/devops-backend:${BUILD_NUMBER} \
                                            ${DOCKER_USERNAME}/devops-backend:latest
                            '''
                        }
                    }
                }

                stage('Frontend Image') {
                    steps {
                        sh '''
                            docker build \
                              --build-arg API_URL=${API_URL} \
                              -t ${DOCKER_USERNAME}/devops-frontend:${BUILD_NUMBER} .

                            docker tag ${DOCKER_USERNAME}/devops-frontend:${BUILD_NUMBER} \
                                       ${DOCKER_USERNAME}/devops-frontend:latest
                        '''
                    }
                }
            }
        }

        // =====================================================
        // 5Ô∏è‚É£ PUSH DOCKER IMAGES
        // =====================================================
        stage('Push to Docker Hub') {
            steps {
                echo "üì§ Pushing images to Docker Hub..."

                withCredentials([usernamePassword(
                    credentialsId: 'docker-hub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

                        docker push $DOCKER_USER/devops-backend:${BUILD_NUMBER}
                        docker push $DOCKER_USER/devops-backend:latest

                        docker push $DOCKER_USER/devops-frontend:${BUILD_NUMBER}
                        docker push $DOCKER_USER/devops-frontend:latest
                    '''
                }
            }
        }

        // =====================================================
        // 6Ô∏è‚É£ DEPLOY TO KUBERNETES (k3s)
        // =====================================================
        stage('Deploy to Kubernetes') {
            steps {
                echo "üöÄ Deploying to Kubernetes (k3s)..."

                withCredentials([file(
                    credentialsId: 'app-env-file',
                    variable: 'ENV_FILE'
                )]) {
                    sh '''
                        kubectl create secret generic app-env \
                          --from-env-file=$ENV_FILE \
                          -n $KUBE_NAMESPACE \
                          --dry-run=client -o yaml | kubectl apply -f -
                    '''
                }

                sh 'kubectl apply -n $KUBE_NAMESPACE -f k8s/mysql/'
                sh 'kubectl apply -n $KUBE_NAMESPACE -f k8s/backend/'
                sh 'kubectl apply -n $KUBE_NAMESPACE -f k8s/frontend/'

                sh '''
                    kubectl rollout status deployment/mysql-deployment    -n $KUBE_NAMESPACE || true
                    kubectl rollout status deployment/backend-deployment  -n $KUBE_NAMESPACE || true
                    kubectl rollout status deployment/frontend-deployment -n $KUBE_NAMESPACE || true
                '''

                sh 'kubectl get pods -n $KUBE_NAMESPACE'
                sh 'kubectl get svc  -n $KUBE_NAMESPACE'
            }
        }
    }

    // =====================================================
    // üßπ POST ACTIONS
    // =====================================================
    post {

        always {
            echo "üßπ Cleaning workspace & Docker images..."
            cleanWs()
            sh 'docker image prune -f'
        }

        success {
            echo "‚úÖ Pipeline executed successfully!"
            echo "üìä SonarQube: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"
        }

        failure {
            echo "‚ùå Pipeline failed. Check Jenkins logs."
        }
    }
}
