pipeline {
    agent any

    environment {
        // =============================
        // Configuration générale Docker
        // =============================
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_USERNAME = 'jihedmekni'
        // DOCKER_PASSWORD doit être configuré dans Jenkins Credentials

        // =============================
        // SonarQube Configuration
        // =============================
        SONAR_HOST_URL = 'http://51.68.70.207:9000'
        SONAR_PROJECT_KEY = 'devops-fullstack'
        // SONAR_TOKEN doit être configuré dans Jenkins Credentials

        // =============================
        // API URL pour Frontend
        // =============================
        API_URL = 'http://51.68.70.207:5000'

        // =============================
        // Kubeconfig pour Minikube
        // =============================
        KUBECONFIG = '/var/lib/jenkins/.kube/config'
    }

    triggers {
        // Vérifie les changements SCM toutes les 5 minutes
        pollSCM('H/5 * * * *')
        // Accepte les notifications de GitHub Webhook
    }

    stages {

        // =============================
        // 1️⃣ Checkout du code
        // =============================
        stage('Checkout') {
            steps {
                script {
                    echo "Checking out code from Git..."
                    checkout scm
                    sh 'git branch --show-current'
                }
            }
        }

        // =============================
        // 2️⃣ Installation des dépendances
        // =============================
        stage('Install Dependencies') {
            steps {
                script {
                    echo "Installing dependencies..."
                    parallel(
                        "Backend": {
                            dir('server') {
                                sh 'npm ci'
                            }
                        },
                        "Frontend": {
                            sh 'npm ci'
                        }
                    )
                }
            }
        }

        // =============================
        // 3️⃣ Build des images Docker
        // =============================
        stage('Build Docker Images') {
            steps {
                script {
                    echo "Building Docker Images..."
                    parallel(
                        "Backend Build": {
                            dir('server') {
                                sh """
                                    docker build -t ${DOCKER_USERNAME}/devops-backend:${BUILD_NUMBER} .
                                    docker tag ${DOCKER_USERNAME}/devops-backend:${BUILD_NUMBER} ${DOCKER_USERNAME}/devops-backend:latest
                                """
                            }
                        },
                        "Frontend Build": {
                            sh """
                                docker build --build-arg API_URL=${API_URL} -t ${DOCKER_USERNAME}/devops-frontend:${BUILD_NUMBER} .
                                docker tag ${DOCKER_USERNAME}/devops-frontend:${BUILD_NUMBER} ${DOCKER_USERNAME}/devops-frontend:latest
                            """
                        }
                    )
                }
            }
        }

        // =============================
        // 4️⃣ Push Docker Hub
        // =============================
        stage('Push to Docker Hub') {
            steps {
                script {
                    echo "Pushing images to Docker Hub..."
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-credentials',
                        usernameVariable: 'DOCKER_USERNAME_VAR',
                        passwordVariable: 'DOCKER_PASSWORD'
                    )]) {
                        sh '''
                            # Login Docker sécurisé
                            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME_VAR" --password-stdin

                            # Push Backend
                            docker push ${DOCKER_USERNAME_VAR}/devops-backend:${BUILD_NUMBER}
                            docker push ${DOCKER_USERNAME_VAR}/devops-backend:latest

                            # Push Frontend
                            docker push ${DOCKER_USERNAME_VAR}/devops-frontend:${BUILD_NUMBER}
                            docker push ${DOCKER_USERNAME_VAR}/devops-frontend:latest
                        '''
                    }
                }
            }
        }

        // =============================
        // 5️⃣ Déploiement Kubernetes (Minikube)
        // =============================
        stage('Deploy to Kubernetes (Minikube)') {
            steps {
                script {
                    echo "Deploying to Kubernetes..."
                    
                    // Crée le secret à partir du fichier .env
                    sh 'kubectl create secret generic app-env --from-env-file=.env --dry-run=client -o yaml | kubectl apply -f -'

                    // Applique les manifests
                    sh 'kubectl apply -f k8s/mysql/'
                    sh 'kubectl apply -f k8s/backend/'
                    sh 'kubectl apply -f k8s/frontend/'

                    // Vérifie les déploiements
                    sh '''
                        kubectl rollout status deployment/mysql-deployment || true
                        kubectl rollout status deployment/backend-deployment || true
                        kubectl rollout status deployment/frontend-deployment || true
                    '''

                    // Affiche les services
                    sh 'kubectl get svc'
                }
            }
        }

        // =============================
        // (Optionnel) Tests, SonarQube, DAST, Staging
        // =============================
        // Les stages pour tests unitaires, SonarQube scan, OWASP ZAP ou Docker Compose staging
        // peuvent être réactivés ici en les décommentant
    }

    post {
        always {
            echo "Cleaning up workspace..."
            cleanWs()
        }
        success {
            echo "Pipeline succeeded! ✅"
        }
        failure {
            echo "Pipeline failed! ❌"
        }
    }
}
